---
layout: post
title: 蓝队总结
excerpt: "蓝队总结"
categories: [知识总结]
comments: true
---
### Sysmon
Sysmon以系统服务和设备驱动程序的方法安装在系统上，并保持常驻性。sysmon用来监视和记录系统活动，并记录到windows事件日志，可以提供有关进程创建，网络链接和文件创建时间更改的详细信息。

###### 采用默认的方式进行安装
```
Sysmon64.exe -accepteula  -i
或者
sysmon -accepteula –i –h md5,sha256 –n
```
###### 卸载
```
sysmon -u force
```

### 使用inf安装服务
`mortyservice.inf`
```
[Version]
Signature="$WINDOWS NT$"
[DefaultInstall.Services]
AddService=sysnap,,My_AddService_Name
[My_AddService_Name]
DisplayName=morty
Description=显示mortyDescription
ServiceType=0x10
StartType=2
ErrorControl=0
ServiceBinary=E:/calc.exe
```
安装
```
rundll32.exe setupapi,InstallHinfSection DefaultInstall 128 e:/mortyservice.inf
```
### svchost进程解惑
1. Svchost进程工作基本原理?

Svchost.exe文件存在于“%system root%\system32”（例如C:\Windows\system32）目录下，它是Windows NT核心的重要进程（Windows 9X没有该进程），专门为系统启动各种服务的。例如Svchost.exe调用rpcss.dll文件，就会启动rpcss服务（remote procedure call）。

随着windows系统服务不断增多，为了节省系统资源，微软把很多服务做成共享方式，交由 svchost.exe进程来启动。所以Svchost.exe实际上是一个服务宿主，它本身并不能给用户提供任何服务，但是可以用来运行动态链接库DLL文件，从而启动对应的服务。Svchost.exe进程可以同时启动多个服务。
2. Svchost如何启动服务?

由于系统服务都是以动态链接库(DLL)形式实现的，它们把可执行程序指向Svchost，因此Svchost只要调用某个动态链接库，即可启动对应的服务。那么Svchost启动某服务时，又是如何知道应该调用哪个动态链接库？这是由于系统服务在注册表中都设置了相关参数，因此Svchost通过读取某服务在注册表中的信息，即可知道应该调用哪个动态链接库，从而启动该服务。

实例说明：

以Svchost启动helpsvc(Help and Support)服务为例，介绍其启动服务的方法。在Windows XP中点击“开始”　“运行”，输入“services.msc”命令，弹出服务对话框，然后双击打开“Help and Support”服务属性对话框，可以看到helpsvc服务的可执行文件的路径为“C:\WINDOWS\System32\svchost.exe -k netsvcs” ，说明helpsvc服务是依靠SVCHOST调用“netsvcs”参数来实现的，而参数的内容则是存放在系统注册表中的。

在运行对话框中输入“regedit.exe”后回车，打开注册表编辑器，找到`[HKEY_LOCAL_MACHINE\SYSTEM \CurrentControlSet\Services\helpsvc]`项，找到类型为“REG_EXPAND_SZ”的键“magePath”，其键值为“%SystemRoot%\System32\svchost.exe -k netsvcs”(这就是在服务窗口中看到的服务启动命令)，另外在“Parameters”子项中有个名为“ServiceDll”的键，其值为 “%WINDIR%\PCHealth\HelpCtr\Binaries\pchsvc.dll”，其中“pchsvc.dll”就是helpsvc服务要使用的动态链接库文件。这样SVCHOST进程通过读取“helpsvc”服务注册表信息，就能启动该服务了。

3. Svchost启动了哪些服务?
```
tasklist /svc
```
如果看到哪个Svchost.exe进程后面提示的服务信息是“暂缺”，而不是一个具体的服务名，那么它就是病毒进程了